<html>
	<head>
		<meta charset="UTF-8" />
		<title>Stop the Toxic</title>>
		<style>html,body{height: 100%; margin: 0; background-color}</style>
	</head>
	<body>
		<canvas id="glFrame"></canvas>
		<script type="text/javascript"> 
// setup dependencies
const dependencies = {
	['gl-matrix']: {loaded: null},
	asm: {loaded: null},
	render: {loaded: null},
	bridge: {loaded: null},
};

const sharedObjects = {
	playerView: {id: 0, size: 16, type: Float32Array, data: undefined},
	gameView: {id: 1, size: 16, type: Float32Array, data: undefined},
	input: {id: 2, size: 8, type: Uint8Array, data: undefined}
};

const input = {
	data: undefined,
	clear: function(){},
	jump: function(){},
	left: function(){},
	right: function(){},
	pause: function(){},
	comp: function(){},
	restart: function(){}
}
const matrices = {
	playerView: undefined,
	gameView: undefined
};
function linkSharedObj() {
	console.log(Module);
	const keys = Object.keys(sharedObjects);
	keys.forEach(function(k, i){
		const obj = sharedObjects[k];
		obj.data = new obj.type(Module.HEAP8.buffer, wasmFn.GetPtr(i), obj.size);
		console.log('Ptr: ' + wasmFn.GetPtr(i));
	});
	// link to matrixes
	Object.keys(matrices).forEach(function(k){ matrices[k] = sharedObjects[k].data;});
	
	input.data = sharedObjects.input.data;
}
const loadCallBacks = [
	{dep: ['asm', 'gl-matrix'], f:  linkSharedObj},
	{dep: ['asm', 'gl-matrix', 'render'], f: initRenderLoop}];

function LoadedDep(dep) {
	dependencies[dep].loaded = true;
	loadCallBacks.filter(function(el) {
		return  !!!el.dep  || (el.dep.includes(dep) && el.dep.every(function(d) {return dependencies[d].loaded;}));})
		.forEach(function(el) {el.f();});
}
const wasmFn = {};
function LodaedASM() {
	// function mapping
	wasmFn.loadMatrix = Module.cwrap('loadMatrix', null, ['number']);
	wasmFn.GetPtr = Module.cwrap('GetPtr', 'number', ['number']);
	wasmFn.Update = Module.cwrap('Update', 'number', null);

	LoadedDep('asm');
}

function initRenderLoop() {
	buildScene(gl);
}

// setup webasm
var Module = {
	onRuntimeInitialized: function(){LodaedASM();}	
};

// load gl context
const gl = document.getElementById('glFrame').getContext('webgl');
if(!!!gl) {
	alert('critial error: no webGl support, or data Corruption');
}

// setup refresh loop
var vendors = ['webkit', 'moz'];
for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
    window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
    window.cancelAnimationFrame =
      window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
}
if (!window.requestAnimationFrame)
    window.requestAnimationFrame = function(callback, element) {
        var currTime = new Date().getTime();
        var timeToCall = Math.max(0, 16 - (currTime - lastTime));
        var id = window.setTimeout(function() { callback(currTime + timeToCall); },
          timeToCall);
        lastTime = currTime + timeToCall;
        return id;
};

if (!window.cancelAnimationFrame)
    window.cancelAnimationFrame = function(id) {
      clearTimeout(id);
};
		</script>
		<script async type="text/javascript" onload="LoadedDep('gl-matrix')" src='gl-matrix.js'></script>
		<script async type="text/javascript" onload="LoadedDep('render')" src='render.js'></script>
		<script async type="text/javascript" onload="LoadedDep('bridge')" src="bridge.js"></script>
		<script async src='wasmLoader.js'></script>
	</body>
</html>
